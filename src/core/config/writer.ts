import { homedir } from "node:os";
import { join } from "node:path";
import { writeFile, mkdir, chmod } from "node:fs/promises";
import {
  CLAUDE_CONFIG_DIR,
  REVENIUM_ENV_FILE,
  CONFIG_FILE_MODE,
  ENV_VARS,
  getCostMultiplier,
  type SubscriptionTier,
} from "../../utils/constants.js";
import type { ReveniumConfig } from "../../types/index.js";
import { getFullOtlpEndpoint } from "./loader.js";

/**
 * Escapes a value for use in shell export statements.
 * Wraps the value in double quotes and escapes special characters.
 */
function escapeShellValue(value: string): string {
  return `"${value.replace(/\\/g, "\\\\").replace(/"/g, '\\"').replace(/\$/g, "\\$").replace(/`/g, "\\`")}"`;
}

/**
 * Escapes a value for use in OTEL_RESOURCE_ATTRIBUTES.
 * OTEL_RESOURCE_ATTRIBUTES uses comma as delimiter and equals as key-value separator.
 * Characters that need escaping: comma (,), equals (=), and double-quote (").
 * We URL-encode these characters to ensure safe parsing.
 */
function escapeResourceAttributeValue(value: string): string {
  return value
    .replace(/%/g, "%25") // Escape % first to avoid double-encoding
    .replace(/,/g, "%2C")
    .replace(/=/g, "%3D")
    .replace(/"/g, "%22");
}

/**
 * Gets the path to the Claude config directory.
 */
function getClaudeConfigDir(): string {
  return join(homedir(), CLAUDE_CONFIG_DIR);
}

/**
 * Generates the content for the revenium.env file.
 */
function generateEnvContent(config: ReveniumConfig): string {
  const fullEndpoint = getFullOtlpEndpoint(config.endpoint);

  const lines: string[] = [
    "# Revenium Claude Code Metering Configuration",
    "# Generated by @revenium/claude-code-metering",
    "#",
    "# To load these variables, add to your shell profile:",
    "#   source ~/.claude/revenium.env",
    "",
    "# Enable Claude Code telemetry export",
    `export ${ENV_VARS.TELEMETRY_ENABLED}=1`,
    "",
    "# OTLP endpoint for Revenium metering",
    `export ${ENV_VARS.OTLP_ENDPOINT}=${escapeShellValue(fullEndpoint)}`,
    "",
    "# Authentication header with API key",
    `export ${ENV_VARS.OTLP_HEADERS}=${escapeShellValue(`x-api-key=${config.apiKey}`)}`,
    "",
    "# OTLP protocol (required for Claude Code)",
    `export ${ENV_VARS.OTLP_PROTOCOL}=http/json`,
    "",
    "# Enable OTLP logs exporter (required to send telemetry)",
    "export OTEL_LOGS_EXPORTER=otlp",
  ];

  // Add optional fields
  if (config.email) {
    lines.push("");
    lines.push("# Subscriber email for attribution");
    lines.push(
      `export ${ENV_VARS.SUBSCRIBER_EMAIL}=${escapeShellValue(config.email)}`,
    );
  }

  if (config.subscriptionTier) {
    const tier = config.subscriptionTier as SubscriptionTier;
    const costMultiplier =
      config.costMultiplierOverride ?? getCostMultiplier(tier);
    const discountPercent = Math.round((1 - costMultiplier) * 100);

    lines.push("");
    lines.push("# Claude Code subscription tier");
    lines.push(
      `export ${ENV_VARS.SUBSCRIPTION}=${escapeShellValue(config.subscriptionTier)}`,
    );

    lines.push("");
    lines.push("# Cost multiplier for subscription tier");
    lines.push(
      "# This adjusts Claude Code costs based on your subscription discount",
    );
    lines.push(`# ${tier}: ${discountPercent}% discount vs API rates`);
    if (config.costMultiplierOverride !== undefined) {
      lines.push("# (custom override applied)");
      lines.push(`export ${ENV_VARS.COST_MULTIPLIER}=${costMultiplier}`);
    }
    // Build OTEL_RESOURCE_ATTRIBUTES with cost_multiplier and optional organization.name/product.name.
    // Special characters (,=") in values are URL-encoded to ensure safe parsing.
    // Note: The backend ONLY reads organization.name and product.name from resourceAttributes,
    // ignoring any auto-generated values in log record attributes from Claude Code.
    const resourceAttrs: string[] = [`cost_multiplier=${costMultiplier}`];

    // Support both new (organizationName) and old (organizationId) field names with fallback
    const organizationValue = config.organizationName || config.organizationId;
    if (organizationValue) {
      resourceAttrs.push(
        `organization.name=${escapeResourceAttributeValue(organizationValue)}`,
      );
    }

    // Support both new (productName) and old (productId) field names with fallback
    const productValue = config.productName || config.productId;
    if (productValue) {
      resourceAttrs.push(
        `product.name=${escapeResourceAttributeValue(productValue)}`,
      );
    }
    lines.push(`export OTEL_RESOURCE_ATTRIBUTES="${resourceAttrs.join(",")}"`);
  }

  // Add advanced configuration section
  lines.push("");
  lines.push(
    "# ─────────────────────────────────────────────────────────────────────────────",
  );
  lines.push("# Organization & Product Attribution (Optional)");
  lines.push(
    "# ─────────────────────────────────────────────────────────────────────────────",
  );
  lines.push("#");
  lines.push(
    "# To attribute Claude Code costs to a specific organization or product, you must",
  );
  lines.push(
    "# add them to OTEL_RESOURCE_ATTRIBUTES above. The backend ONLY reads these values",
  );
  lines.push(
    "# from OTEL_RESOURCE_ATTRIBUTES - standalone environment variables are NOT sent.",
  );
  lines.push("#");
  lines.push("# HOW TO CONFIGURE:");
  lines.push(
    "# Edit the OTEL_RESOURCE_ATTRIBUTES line above to include organization.name and/or product.name:",
  );
  lines.push("#");

  // Get current cost multiplier for the example
  const exampleMultiplier =
    config.subscriptionTier && config.costMultiplierOverride === undefined
      ? getCostMultiplier(config.subscriptionTier as SubscriptionTier)
      : (config.costMultiplierOverride ?? "0.08");
  lines.push(
    `#   OTEL_RESOURCE_ATTRIBUTES="cost_multiplier=${exampleMultiplier},organization.name=my-org,product.name=my-product"`,
  );
  lines.push("#");
  lines.push("# ATTRIBUTE DESCRIPTIONS:");
  lines.push(
    "#   organization.name - Attribute costs to a customer/company (e.g., client name, team)",
  );
  lines.push(
    "#   product.name      - Attribute costs to a product/project (e.g., mobile-app, backend-api)",
  );
  lines.push("#");
  lines.push(
    "# After editing, restart your terminal or run: source ~/.claude/revenium.env",
  );
  lines.push("#");
  lines.push(
    "# Alternatively, re-run setup with --organization and --product flags:",
  );
  lines.push(
    "#   npx @revenium/claude-code-metering setup --organization my-org --product my-product",
  );

  lines.push("");
  return lines.join("\n");
}

/**
 * Writes the Revenium configuration to ~/.claude/revenium.env.
 * Creates the directory if it doesn't exist and sets file permissions to 600.
 */
export async function writeConfig(config: ReveniumConfig): Promise<string> {
  const configDir = getClaudeConfigDir();
  const configPath = join(configDir, REVENIUM_ENV_FILE);

  // Ensure the directory exists
  await mkdir(configDir, { recursive: true });

  // Generate and write the content
  const content = generateEnvContent(config);
  await writeFile(configPath, content, { encoding: "utf-8" });

  // Set restrictive permissions (owner read/write only)
  await chmod(configPath, CONFIG_FILE_MODE);

  return configPath;
}

/**
 * Gets the path where the config file would be written.
 */
export function getConfigFilePath(): string {
  return join(getClaudeConfigDir(), REVENIUM_ENV_FILE);
}
