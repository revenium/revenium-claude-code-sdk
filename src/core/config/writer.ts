import { homedir } from 'node:os';
import { join, dirname } from 'node:path';
import { writeFile, mkdir, chmod } from 'node:fs/promises';
import {
  CLAUDE_CONFIG_DIR,
  REVENIUM_ENV_FILE,
  CONFIG_FILE_MODE,
  ENV_VARS,
  getCostMultiplier,
  type SubscriptionTier,
} from '../../utils/constants.js';
import type { ReveniumConfig } from '../../types/index.js';
import { getFullOtlpEndpoint } from './loader.js';

/**
 * Escapes a value for use in OTEL_RESOURCE_ATTRIBUTES.
 * OTEL_RESOURCE_ATTRIBUTES uses comma as delimiter and equals as key-value separator.
 * Characters that need escaping: comma (,), equals (=), and double-quote (").
 * We URL-encode these characters to ensure safe parsing.
 */
function escapeResourceAttributeValue(value: string): string {
  return value
    .replace(/%/g, '%25') // Escape % first to avoid double-encoding
    .replace(/,/g, '%2C')
    .replace(/=/g, '%3D')
    .replace(/"/g, '%22');
}

/**
 * Gets the path to the Claude config directory.
 */
function getClaudeConfigDir(): string {
  return join(homedir(), CLAUDE_CONFIG_DIR);
}

/**
 * Generates the content for the revenium.env file.
 */
function generateEnvContent(config: ReveniumConfig): string {
  const fullEndpoint = getFullOtlpEndpoint(config.endpoint);

  const lines: string[] = [
    '# Revenium Claude Code Metering Configuration',
    '# Generated by @revenium/claude-code-metering',
    '#',
    '# To load these variables, add to your shell profile:',
    '#   source ~/.claude/revenium.env',
    '',
    '# Enable Claude Code telemetry export',
    `export ${ENV_VARS.TELEMETRY_ENABLED}=1`,
    '',
    '# OTLP endpoint for Revenium metering',
    `export ${ENV_VARS.OTLP_ENDPOINT}=${fullEndpoint}`,
    '',
    '# Authentication header with API key',
    `export ${ENV_VARS.OTLP_HEADERS}="x-api-key=${config.apiKey}"`,
    '',
    '# OTLP protocol (required for Claude Code)',
    `export ${ENV_VARS.OTLP_PROTOCOL}=http/json`,
    '',
    '# Enable OTLP metrics exporter (required to send telemetry)',
    'export OTEL_METRICS_EXPORTER=otlp',
  ];

  // Add optional fields
  if (config.email) {
    lines.push('');
    lines.push('# Subscriber email for attribution');
    lines.push(`export ${ENV_VARS.SUBSCRIBER_EMAIL}=${config.email}`);
  }

  if (config.subscriptionTier) {
    const tier = config.subscriptionTier as SubscriptionTier;
    const costMultiplier = config.costMultiplierOverride ?? getCostMultiplier(tier);
    const discountPercent = Math.round((1 - costMultiplier) * 100);

    lines.push('');
    lines.push('# Claude Code subscription tier');
    lines.push(`export ${ENV_VARS.SUBSCRIPTION}=${config.subscriptionTier}`);

    lines.push('');
    lines.push('# Cost multiplier for subscription tier');
    lines.push('# This adjusts Claude Code costs based on your subscription discount');
    lines.push(`# ${tier}: ${discountPercent}% discount vs API rates`);
    if (config.costMultiplierOverride !== undefined) {
      lines.push('# (custom override applied)');
      lines.push(`export ${ENV_VARS.COST_MULTIPLIER}=${costMultiplier}`);
    }
    // Build OTEL_RESOURCE_ATTRIBUTES with cost_multiplier and optional fields
    // Special characters (,=") in values are URL-encoded to ensure safe parsing
    const resourceAttrs: string[] = [`cost_multiplier=${costMultiplier}`];
    if (config.organizationId) {
      resourceAttrs.push(`organization.id=${escapeResourceAttributeValue(config.organizationId)}`);
    }
    if (config.productId) {
      resourceAttrs.push(`product.id=${escapeResourceAttributeValue(config.productId)}`);
    }
    lines.push(`export OTEL_RESOURCE_ATTRIBUTES="${resourceAttrs.join(',')}"`);
  }

  // Add advanced configuration section (commented out by default)
  lines.push('');
  lines.push('# ─────────────────────────────────────────────────────────────────────────────');
  lines.push('# Advanced Configuration (Optional)');
  lines.push('# ─────────────────────────────────────────────────────────────────────────────');
  lines.push('#');
  lines.push('# IMPORTANT: If you enable organization/product attribution below, you must also');
  lines.push('# update OTEL_RESOURCE_ATTRIBUTES above to include them. For example:');
  lines.push('#   export OTEL_RESOURCE_ATTRIBUTES="cost_multiplier=0.08,organization.id=my-org,product.id=my-product"');
  lines.push('# Otherwise, the telemetry sent to Revenium will not include the attribution data.');
  lines.push('# Run `npx @revenium/claude-code-metering setup` again to regenerate this file with');
  lines.push('# the correct OTEL_RESOURCE_ATTRIBUTES if you want automatic configuration.');
  lines.push('#');
  lines.push('# Organization ID: Attribute Claude Code costs to a specific customer or company.');
  lines.push('# Use this when you want to track AI development costs by client/organization.');
  lines.push('# Example: Your consulting firm tracks costs per client project.');
  if (config.organizationId) {
    lines.push(`export ${ENV_VARS.ORGANIZATION_ID}=${config.organizationId}`);
  } else {
    lines.push(`# export ${ENV_VARS.ORGANIZATION_ID}=your-organization-id`);
  }
  lines.push('#');
  lines.push('# Product ID: Attribute Claude Code costs to a specific product or project.');
  lines.push('# Use this when you want to track AI development costs by internal product.');
  lines.push('# Example: Separate AI costs for "mobile-app" vs "backend-api" development.');
  if (config.productId) {
    lines.push(`export ${ENV_VARS.PRODUCT_ID}=${config.productId}`);
  } else {
    lines.push(`# export ${ENV_VARS.PRODUCT_ID}=your-product-id`);
  }

  lines.push('');
  return lines.join('\n');
}

/**
 * Writes the Revenium configuration to ~/.claude/revenium.env.
 * Creates the directory if it doesn't exist and sets file permissions to 600.
 */
export async function writeConfig(config: ReveniumConfig): Promise<string> {
  const configDir = getClaudeConfigDir();
  const configPath = join(configDir, REVENIUM_ENV_FILE);

  // Ensure the directory exists
  await mkdir(configDir, { recursive: true });

  // Generate and write the content
  const content = generateEnvContent(config);
  await writeFile(configPath, content, { encoding: 'utf-8' });

  // Set restrictive permissions (owner read/write only)
  await chmod(configPath, CONFIG_FILE_MODE);

  return configPath;
}

/**
 * Gets the path where the config file would be written.
 */
export function getConfigFilePath(): string {
  return join(getClaudeConfigDir(), REVENIUM_ENV_FILE);
}
